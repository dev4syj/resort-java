<!DOCTYPE html>
<html lang='en'>

<!-- Header -->
<th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

<script th:inline="javascript">
	var isAdmin = [[${#authorization.expression('hasRole(''ROLE_ADMIN'')')}]];

	document.addEventListener('DOMContentLoaded', function () {
		var calendarEl = document.getElementById('calendar');

		// 서버로부터 이벤트 데이터 가져오기
		var request = $.ajax({
			url: "/event",
			method: "GET"
		});

		request.done(function (data) {
			// 캘린더 초기화
			var calendar = new FullCalendar.Calendar(calendarEl, {
				initialView: 'dayGridMonth',
				locale: 'ko',
				eventClick: function(info) {
					if (isAdmin) {
						var reservationId = info.event.id;
						loadReservationDetail(reservationId);
					}
				}
			});

			// FullCalendar에 이벤트 추가
			calendar.addEventSource(data);

			// 캘린더 렌더링
			calendar.render();
		});
	});

	function loadReservationDetail(reservationId) {
		$.ajax({
			url: "/admin/reservation/" + reservationId + "/json",
			method: "GET",
			success: function(data) {
				if (data.success) {
					$('#modalReservationId').text(data.reservationId);
					$('#modalUserName').text(data.userName || '-');
					$('#modalUserPhone').text(data.userPhone || '-');
					$('#modalUserEmail').text(data.userEmail || '-');
					$('#modalRoomType').text(data.roomType);
					$('#modalCheckIn').text(data.checkInDate);
					$('#modalCheckOut').text(data.checkOutDate);
					$('#modalAdult').text(data.adult);
					$('#modalChildren').text(data.children);

					$('#editBtn').attr('href', '/admin/reservation/' + reservationId);
					$('#deleteForm').attr('action', '/admin/reservation/' + reservationId + '/delete');

					$('#reservationModal').modal('show');
				} else {
					alert('예약 정보를 불러올 수 없습니다.');
				}
			},
			error: function() {
				alert('예약 정보를 불러오는 중 오류가 발생했습니다.');
			}
		});
	}
</script>

<body>
	<!-- Navbar -->
	<nav th:replace="~{navbar :: navbarFragment}"></nav>

	<!-- Page Header -->
	<div class="container-fluid page-header py-5 mb-5 wow fadeIn" data-wow-delay="0.1s">
		<div class="container text-center py-5">
			<h1 class="display-3 text-white mb-4 animated slideInDown">Calendar</h1>
		</div>
	</div>

	<!-- Calendar -->
	<div id="wrapper mx-10">
		<div class="container">
			<div class="text-center mx-auto wow fadeInUp" data-wow-delay="0.2s" style="max-width: 500px;">
				<p class="fs-5 fw-bold text-primary">Do you Wanna go on vacation?</p>
				<h1 class="display-5 mb-5">Reservation Status</h1>
			</div>
			<div id='calendar' class="wow fadeInUp"></div>
		</div>
	</div>

	<!-- Reservation Detail Modal (Admin Only) -->
	<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true"
		 sec:authorize="hasRole('ADMIN')">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="reservationModalLabel">예약 상세 정보</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<table class="table table-borderless">
						<tr>
							<th width="30%">예약번호</th>
							<td id="modalReservationId"></td>
						</tr>
						<tr>
							<th>예약자</th>
							<td id="modalUserName"></td>
						</tr>
						<tr>
							<th>연락처</th>
							<td id="modalUserPhone"></td>
						</tr>
						<tr>
							<th>이메일</th>
							<td id="modalUserEmail"></td>
						</tr>
						<tr>
							<th>객실</th>
							<td id="modalRoomType"></td>
						</tr>
						<tr>
							<th>체크인</th>
							<td id="modalCheckIn"></td>
						</tr>
						<tr>
							<th>체크아웃</th>
							<td id="modalCheckOut"></td>
						</tr>
						<tr>
							<th>성인</th>
							<td id="modalAdult"></td>
						</tr>
						<tr>
							<th>어린이</th>
							<td id="modalChildren"></td>
						</tr>
					</table>
				</div>
				<div class="modal-footer">
					<form id="deleteForm" method="post" style="display:inline;" onsubmit="return confirm('정말 취소하시겠습니까?');">
						<button type="submit" class="btn btn-danger">예약 취소</button>
					</form>
					<a id="editBtn" href="#" class="btn btn-primary">수정</a>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>

</body>

</html>